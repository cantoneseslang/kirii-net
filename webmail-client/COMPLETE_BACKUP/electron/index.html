<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Kmail Client with WhatsApp</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
        }
        
        .container {
            display: flex;
            flex-direction: column; /* 縦並び固定 - 左右分割は禁止 */
            height: 100vh;
            overflow: hidden;
        }
        
        /* 
        ⚠️ 重要: レイアウト変更禁止 ⚠️
        - flex-direction: row への変更は禁止
        - 左右分割レイアウトは使用禁止
        - メールアプリとWhatsAppは縦に並ぶ必要がある
        - この変更により問題が発生する可能性があるため、絶対に変更しないでください
        */
        
        /* 設定パネル */
        .settings-panel {
            background: #2c3e50;
            color: white;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 14px;
            border-bottom: 1px solid #34495e;
        }
        
        .settings-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        

        
        .settings-group label {
            font-weight: 500;
            min-width: 80px;
        }
        
        .settings-group input {
            width: 60px;
            padding: 4px 8px;
            border: 1px solid #34495e;
            border-radius: 4px;
            background: #34495e;
            color: white;
            text-align: center;
        }
        
        .settings-group input:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .apply-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }
        
        .apply-btn:hover {
            background: #2980b9;
        }
        
        .panel {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        webview {
            width: 100%;
            height: 100%;
            border: none;
            outline: none;
        }
        
        /* WebView内のすべての境界線を削除 */
        webview * {
            border: none !important;
            outline: none !important;
        }
        
        /* 特に境界線が表示されやすい要素を対象に */
        webview hr,
        webview .border,
        webview .border-bottom,
        webview .border-top,
        webview .border-left,
        webview .border-right,
        webview [class*="border"] {
            border: none !important;
            border-bottom: none !important;
            border-top: none !important;
            border-left: none !important;
            border-right: none !important;
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
        }
        
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- 設定パネル -->
    <div class="settings-panel">
        <div class="settings-group">
            <label>メールアプリ:</label>
            <input type="number" id="email-zoom" value="100" min="50" max="150" step="5">
            <span>%</span>
        </div>
        <div class="settings-group">
            <label>WhatsApp:</label>
            <input type="number" id="whatsapp-zoom" value="100" min="50" max="150" step="5">
            <span>%</span>
        </div>

        <button class="apply-btn" onclick="applyZoomSettings()">適用</button>
    </div>

    <div class="container">
        <!-- メールアプリケーション パネル（上半分） -->
        <div class="panel" id="email-panel">
            <webview 
                id="email-webview" 
                src="http://localhost:3000"
                preload="./preload.js"
                style="border: none; outline: none;"
                allowpopups
                webpreferences="allowRunningInsecureContent=true">
            </webview>
        </div>
        
        <!-- WhatsApp Web パネル（下半分） -->
        <div class="panel" id="whatsapp-panel">
            <webview 
                id="whatsapp-webview" 
                src="https://web.whatsapp.com"
                preload="./preload.js"
                style="border: none; outline: none;">
            </webview>
        </div>
    </div>

    <script>
        // 初期化フラグ
        let emailInitialized = false;
        let whatsappInitialized = false;
        
        // ズーム設定を適用する関数
        function applyZoomSettings() {
            const emailZoom = document.getElementById('email-zoom').value;
            const whatsappZoom = document.getElementById('whatsapp-zoom').value;
            
            // メールアプリのズームを適用（WebViewのズーム機能を使用）
            setTimeout(() => {
                const emailScale = emailZoom / 100;
                emailWebview.setZoomFactor(emailScale);
                console.log('Email zoom factor set to:', emailScale);
            }, 500);
            
            // WhatsAppのズームを適用
            setTimeout(() => {
                const whatsappPanel = document.getElementById('whatsapp-panel');
                const whatsappWebviewElement = document.getElementById('whatsapp-webview');
                const scale = whatsappZoom / 100;
                
                // WebViewのズーム機能を使用（情報密度を上げる）
                whatsappWebviewElement.style.transform = 'none';
                whatsappWebviewElement.style.width = '100%';
                whatsappWebviewElement.style.height = '100%';
                whatsappPanel.style.overflow = 'visible';
                
                // WebViewのズームレベルを設定
                whatsappWebview.setZoomFactor(scale);
                
                console.log('WhatsApp zoom factor set to:', scale);
                
                console.log('WhatsApp WebView size adjusted:', {
                    scale: scale,
                    width: scale !== 1.0 ? (100 / scale) + '%' : '100%',
                    height: scale !== 1.0 ? (100 / scale) + '%' : '100%'
                });
                
                // 実際のサイズを確認
                console.log('Actual WebView size:', {
                    offsetWidth: whatsappWebviewElement.offsetWidth,
                    offsetHeight: whatsappWebviewElement.offsetHeight,
                    clientWidth: whatsappWebviewElement.clientWidth,
                    clientHeight: whatsappWebviewElement.clientHeight
                });
                
                // WhatsAppの小さいサイズ対応のためのCSS注入
                whatsappWebview.executeJavaScript(`
                    (function() {
                        const existingStyle = document.getElementById('electron-responsive-style');
                        if (existingStyle) {
                            existingStyle.remove();
                        }
                        
                        const responsiveStyle = document.createElement('style');
                        responsiveStyle.id = 'electron-responsive-style';
                        responsiveStyle.textContent = \`
                            /* WhatsAppの小さいサイズ対応 */
                            [data-testid="main-app-wrap"] {
                                min-width: 300px !important;
                            }
                            
                            /* チャットリストの幅調整 */
                            [data-testid="side"] {
                                min-width: 200px !important;
                                max-width: none !important;
                            }
                            
                            /* メインチャット領域の調整 */
                            [data-testid="conversation-panel-wrapper"] {
                                min-width: 200px !important;
                            }
                            
                            /* レスポンシブ制限を解除 */
                            @media (max-width: 1120px) {
                                [data-testid="main-app-wrap"] {
                                    display: flex !important;
                                }
                            }
                        \`;
                        document.head.appendChild(responsiveStyle);
                    })();
                `);
            }, 500);
        }
        
        // WebView内の境界線を削除し、初期ズームを設定する関数
        function removeBorders(webview) {
            webview.addEventListener('dom-ready', () => {
                // 各WebViewの初期化フラグをチェック
                if (webview.src.includes('whatsapp.com')) {
                    if (whatsappInitialized) return; // 既に初期化済みの場合はスキップ
                    whatsappInitialized = true;
                } else {
                    if (emailInitialized) return; // 既に初期化済みの場合はスキップ
                    emailInitialized = true;
                }
                
                // 初期設定は遅延実行でハイドレーション完了を待つ
                setTimeout(() => {
                    // WhatsAppの場合、初期ズームレベルを設定
                    if (webview.src.includes('whatsapp.com')) {
                        // WebViewのズーム機能を使用（統一された方式）
                        webview.setZoomFactor(1.0);
                        
                        webview.executeJavaScript(`
                            (function() {
                                // 境界線削除のみ
                                const existingBorderStyle = document.getElementById('electron-border-removal');
                                if (existingBorderStyle) existingBorderStyle.remove();
                                
                                const borderStyle = document.createElement('style');
                                borderStyle.id = 'electron-border-removal';
                                borderStyle.textContent = '* { border: none !important; outline: none !important; } hr, .border, .border-bottom, .border-top, .border-left, .border-right, [class*="border"] { border: none !important; border-bottom: none !important; border-top: none !important; border-left: none !important; border-right: none !important; }';
                                document.head.appendChild(borderStyle);
                            })();
                        `);
                    } else {
                        // メールアプリは初期ズーム100%（WebViewのズーム機能を使用）
                        webview.setZoomFactor(1.0);
                        
                        webview.executeJavaScript(`
                            (function() {
                                // 境界線削除のみ
                                const existingBorderStyle = document.getElementById('electron-border-removal');
                                if (existingBorderStyle) existingBorderStyle.remove();
                                
                                const borderStyle = document.createElement('style');
                                borderStyle.id = 'electron-border-removal';
                                borderStyle.textContent = '* { border: none !important; outline: none !important; } hr, .border, .border-bottom, .border-top, .border-left, .border-right, [class*="border"] { border: none !important; border-bottom: none !important; border-top: none !important; border-left: none !important; border-right: none !important; }';
                                document.head.appendChild(borderStyle);
                            })();
                        `);
                    }
                }, 1500); // 1.5秒遅延でハイドレーション完了を待つ
            });
        }
        
        // すべてのWebViewに境界線削除を適用
        const emailWebview = document.getElementById('email-webview');
        const whatsappWebview = document.getElementById('whatsapp-webview');
        
        removeBorders(emailWebview);
        removeBorders(whatsappWebview);
        
        // キーボードショートカット
        document.addEventListener('keydown', (e) => {
            // Ctrl+R でリロード
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                emailInitialized = false; // フラグをリセット
                whatsappInitialized = false; // フラグをリセット
                emailWebview.reload();
                whatsappWebview.reload();
            }
            
            // Ctrl+Shift+R でハードリロード
            if (e.ctrlKey && e.shiftKey && e.key === 'R') {
                e.preventDefault();
                emailInitialized = false; // フラグをリセット
                whatsappInitialized = false; // フラグをリセット
                emailWebview.reloadIgnoringCache();
                whatsappWebview.reloadIgnoringCache();
            }
            
            // Ctrl+Enter でズーム設定を適用
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                applyZoomSettings();
            }
        });
    </script>
</body>
</html> 